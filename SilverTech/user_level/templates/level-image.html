<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>난이도 정보로 그림 제공</title>
    <script>
      // DOM이 로드된 후 초기 이미지를 로드하는 함수 실행
      window.onload = function () {
        loadImage("{{ url }}"); //이미지 로드
      };

      // 그림 순차 출력
      function fetchOrderImage() {
        sendAccuracy() // sendAccuracy를 먼저 실행하고 완료 후 이미지 로드
          .then((data) => {
            if (data && data.level_changed) {
              // 레벨이 변경되었을 경우, 변경된 레벨에 해당하는 그림을 직접 가져옴
              fetch("http://127.0.0.1:8000/picture-load/adjust-level/", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "X-CSRFToken": getCookie("csrftoken"),
                },
                body: JSON.stringify({ action: 0 }), // 레벨 변경 없이 새 이미지 로드
              })
                .then((response) => response.json())
                .then((data) => {
                  if (data.error) {
                    alert("Error: " + data.error);
                  } else {
                    // 새로운 레벨을 세션 또는 클라이언트 측 변수에 저장
                    sessionStorage.setItem("currentLevel", data.new_level);
                    document.getElementById("current-level").innerText =
                      "당신의 난이도: " + data.new_level; // 새로운 난이도 표시
                    if (data.url) {
                      loadImage(data.url); // 새로운 레벨에 맞는 이미지 로드
                      loadInfo(data.url, data.first_picture_order); // 변경된 레벨에 맞는 이미지 정보를 로드
                    }
                  }
                })
                .catch((error) => console.error("Error:", error));
            } else {
              // 레벨 변경이 없을 경우, 기존 로직대로 진행
              fetch("http://127.0.0.1:8000/picture-load/new/", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "Cache-Control": "no-cache",
                },
                body: JSON.stringify({ is_order: true }),
              })
                .then((response) => response.json())
                .then((data) => {
                  var imageUrl = data.url;
                  var imageOrder = data.order;
                  loadImage(imageUrl); // 새로운 이미지를 로드
                  loadInfo(imageUrl, imageOrder); // 이미지 정보 로드
                })
                .catch((error) => console.error("Error:", error));
            }
          });
      }

      // 그림 랜덤 출력
      function fetchRandomImage() {
        sendAccuracy() // sendAccuracy를 먼저 실행하고 완료 후 이미지 로드
          .then(() => {
            fetch("http://127.0.0.1:8000/picture-load/new/", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ is_order: false }),
            })
              .then((response) => response.json())
              .then((data) => {
                var imageUrl = data.url;
                var imageOrder = data.order;
                loadImage(imageUrl); // 새로운 이미지를 로드
                loadInfo(imageUrl, imageOrder); // 이미지 정보 로드
              })
              .catch((error) => console.error("Error:", error));
          });
      }

      // 이미지를 로드하고 화면에 표시하는 함수
      function loadImage(imageUrl) {
        var imageDisplayDiv = document.getElementById("image-display");
        imageDisplayDiv.innerHTML = ""; // 기존 이미지 제거

        var image = new Image();
        image.src = imageUrl;
        image.style.width = "100%";
        image.style.height = "100%";

        imageDisplayDiv.appendChild(image); // 새로운 이미지 추가
      }

      // 이미지 정보(URL 및 순서) 화면에 표기
      function loadInfo(url, order) {
        document.getElementById("current-image-url").innerText =
          "그림 URL: " + url;
        document.getElementById("current-image-order").innerText =
          "그림 순서: " + order;
      }

      // 쿠키
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.startsWith(name + "=")) {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }

      //난이도 변경 함수
      function changeLevel(change) {
        return fetch("http://127.0.0.1:8000/picture-load/adjust-level/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
          },
          body: JSON.stringify({ action: change }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.error) {
              alert("Error: " + data.error);
            } else {
              document.getElementById("current-level").innerText =
                "당신의 난이도: " + data.new_level; // 새로운 난이도 표시
              if (data.url) {
                loadImage(data.url); // 새로운 레벨에 맞는 이미지 로드
                loadInfo(data.url, data.first_picture_order); // 변경된 레벨에 맞는 이미지 정보를 로드
              }
            }
          })
          .catch((error) => console.error("Error:", error));
      }

      // accuracy 값 전송
      function sendAccuracy() {
        const accuracy = 0.7; //임의지정
        const data = { accuracy: accuracy };

        return fetch(
          "http://127.0.0.1:8000/picture-load/adjust-level-with-accuracy",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": getCookie("csrftoken"),
            },
            body: JSON.stringify(data),
          }
        )
          .then((response) => response.json())
          .then((data) => {
            console.log("Success:", data);
            alert("Response: " + JSON.stringify(data));
            if (data.level_changed) {
              return data; // level_changed가 true이면 데이터를 반환
            }
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      }
    </script>
  </head>
  <body>
    <h1>사용자 난이도 정보</h1>
    <p id="current-level">당신의 난이도: {{ level }}</p>
    <p id="current-image-url">그림 URL: {{ url }}</p>
    <p id="current-image-order">그림 순서: {{ order }}</p>

    <button onclick="fetchOrderImage()">다음 그림 보기</button>
    <button onclick="fetchRandomImage()">
      무작위 그림 보기(난이도는 동일)
    </button>
    <div id="level-buttons">
      <button onclick="changeLevel(-1)">레벨 내리기</button>
      <button onclick="changeLevel(1)">레벨 올리기</button>
    </div>

    <div id="image-display" style="width: 600px; height: 600px">
      <!-- 이미지를 띄울 공간 -->
    </div>
  </body>
</html>
